<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Land Mosaic Vision</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet">
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.css" type="text/css">
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof mapboxgl === 'undefined') {
        console.error('Mapbox GL JS no se ha cargado.');
        return;
      }

      mapboxgl.accessToken = 'pk.eyJ1Ijoibmljb2xlODAxIiwiYSI6ImNtMHdvdGE3MzAzbnQybG93aXRncnlqb2QifQ.9G8XyYyv4V1b0OJGRnpEZA';
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-streets-v12',
        center: [0, 0],
        zoom: 2,
        maxZoom: 100, // Limitar el zoom máximo para mejorar el rendimiento
        minZoom: 1   // Limitar el zoom mínimo para evitar cargas innecesarias
      });

      //El codigo anterior es para la integracion del mapbox, no modificar a no ser que sea style, center, zoom, maxzoom, minzoom

      // Carga el servidor en busca de datos
      map.on('load', () => {
        fetch('http://localhost:3000/parcelas')
          .then(response => response.json())
          .then(parcelas => {
            if (!parcelas.length) {
              console.log('No se encontraron parcelas');
              return;
            }

            const bounds = new mapboxgl.LngLatBounds();
            //Se conecta con la base de datos para la visualizacion de las coordenadas de las parcelas
            parcelas.forEach(parcela => {
              new mapboxgl.Marker()
                .setLngLat([parcela.longitud, parcela.latitud])
                .setPopup(new mapboxgl.Popup().setHTML(`
                  <h3>Parcela ID: ${parcela.id_parcelacion}</h3>
                  <p>Coordenadas: ${parcela.latitud}, ${parcela.longitud}</p>
                  <p>Sector: ${parcela.id_sector}</p>
                  <p>Fase: ${parcela.id_fase}</p>
                  <p>Cultivo: ${parcela.id_cultivo}</p>
                `))
                .addTo(map);

              bounds.extend([parcela.longitud, parcela.latitud]);
            });

            map.fitBounds(bounds, { padding: 50 });
            //Aca termina el codigo para visualizar parcelas

            // Empieza el codigo para buscar coordenadas
            const coordinatesGeocoder = function (query) {
              const matches = query.match(/^(-?\d+\.?\d*)[, ]+(-?\d+\.?\d*)$/);
              if (!matches) return null;

              function coordinateFeature(lng, lat) {
                return {
                  center: [lng, lat],
                  geometry: {
                    type: 'Point',
                    coordinates: [lng, lat]
                  },
                  place_name: `Lat: ${lat} Lng: ${lng}`,
                  place_type: ['coordinate'],
                  properties: {},
                  type: 'Feature'
                };
              }

              const coord1 = Number(matches[1]);
              const coord2 = Number(matches[2]);
              const geocodes = [];

              if (Math.abs(coord1) <= 90 && Math.abs(coord2) <= 180) {
                geocodes.push(coordinateFeature(coord1, coord2));
              }

              return geocodes;
            };

            map.addControl(
              new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                localGeocoder: coordinatesGeocoder,
                zoom: 4,
                placeholder: 'Ingrese coordenadas',
                mapboxgl: mapboxgl,
                reverseGeocode: true
              })
            );
          })
          .catch(error => console.error('Error al obtener las parcelas:', error));
      });
      //Aca termina el codigo
    });
  </script>
</body>
</html>
