<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de usuario</title>
</head>
<body>
    <!-- Formulario de registro de usuario -->
    <div>
        <h2>Registro y eliminación de usuario </h2>
        <p>Para la eliminacion de usuario solo debe escribir el Rut</p>
        <form id="registerForm">
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" name="nombre" required>
            <br><br>
            <label for="apellido">Apellido:</label>
            <input type="text" id="apellido" name="apellido" required>
            <br><br>
            <label for="rut">Rut:</label>
            <input type="text" id="rut" name="rut" required pattern="[0-9]{1,10}" title="Solo números enteros" oninput="validarRut(this)">
            <br><br>
            <label for="dv_rut">Dv-Rut:</label>
            <input type="text" id="dv_rut" name="dv_rut" required pattern="[0-9Kk]" maxlength="1" title="Debe ser un número o la letra K">
            <br><br>
            <label for="correo">Correo electrónico:</label>
            <input type="email" id="correo" name="correo" required>
            <br><br>
            <label for="usuario">Usuario:</label>
            <input type="text" id="usuario" name="usuario" required>
            <br><br>
            <label for="contraseña">Contraseña:</label>
            <input type="password" id="contraseña" name="contraseña" required minlength="6" title="La contraseña debe tener al menos 6 caracteres">
            <br><br>
            <label for="rol">Rol:</label>
            <select id="rol" name="rol" required>
                <option value="usuario">Usuario</option>
                <option value="admin">Administrador</option>
            </select>
            <br><br>
            <input type="submit" value="Registrar usuario">
            <!-- Nuevo botón para eliminar usuario -->
            <button type="button" id="deleteButton">Eliminar usuario</button>
            <br><br>
            <button onclick="window.location.href='index.html';">Ir a mapa</button>
        </form>
        <p id="mensajeRegistro"></p>
    </div>
    

    <script>
        // Función de validación de RUT
        function validarRut(input) {
            const rut = input.value;
            const regex = /^[0-9]{1,10}$/; // Solo números
            if (!regex.test(rut)) {
                input.setCustomValidity("El RUT solo debe contener números.");
            } else {
                input.setCustomValidity("");
            }
        }

        // Función para registrar usuario
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Prevenir el comportamiento por defecto del formulario

            const nombre = document.getElementById('nombre').value;
            const apellido = document.getElementById('apellido').value;
            const rut = document.getElementById('rut').value;
            const dv_rut = document.getElementById('dv_rut').value.toUpperCase(); // Convertir DV a mayúsculas
            const correo = document.getElementById('correo').value;
            const usuario = document.getElementById('usuario').value;
            const contraseña = document.getElementById('contraseña').value;
            const rol = document.getElementById('rol').value;

            // Hacer una solicitud POST al backend para registrar el usuario
            fetch('http://localhost:3001/registro', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nombre,
                    apellido,
                    rut,
                    dv_rut,
                    correo,
                    usuario,
                    contraseña,
                    rol
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('mensajeRegistro').innerText = 'Usuario registrado con éxito';
                    document.getElementById('mensajeRegistro').style.color = 'green';
                    document.getElementById('registerForm').reset();
                } else {
                    document.getElementById('mensajeRegistro').innerText = 'Error al registrar usuario: ' + data.message;
                    document.getElementById('mensajeRegistro').style.color = 'red';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('mensajeRegistro').innerText = 'Error en la solicitud';
                document.getElementById('mensajeRegistro').style.color = 'red';
            });
        });

        // Función para eliminar usuario
        document.getElementById('deleteButton').addEventListener('click', function() {
            const rut = document.getElementById('rut').value;

            if (rut === '') {
                document.getElementById('mensajeRegistro').innerText = 'Por favor, ingrese un RUT para eliminar';
                document.getElementById('mensajeRegistro').style.color = 'red';
                return;
            }

            // Hacer una solicitud DELETE al backend para eliminar el usuario
            fetch(`http://localhost:3001/usuario/${rut}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('mensajeRegistro').innerText = 'Usuario eliminado con éxito';
                    document.getElementById('mensajeRegistro').style.color = 'green';
                    document.getElementById('registerForm').reset();
                } else {
                    document.getElementById('mensajeRegistro').innerText = 'Error al eliminar usuario: ' + data.message;
                    document.getElementById('mensajeRegistro').style.color = 'red';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('mensajeRegistro').innerText = 'Error en la solicitud';
                document.getElementById('mensajeRegistro').style.color = 'red';
            });
        });
    </script>
</body>
</html>
