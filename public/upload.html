<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subir Imagen</title>
</head>
<body>
  <h1>Subir Imagen</h1>
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="image" accept="image/*" required>
    <input type="number" name="latitud" placeholder="Latitud" step="any" min="-90" max="90" required>
    <input type="number" name="longitud" placeholder="Longitud" step="any" min="-180" max="180" required>
    <select name="id_sector" id="id_sector" required>
      <option value="">Seleccione un Sector</option>
      <!-- Las opciones se llenarán aquí con JavaScript -->
  </select>

  <select name="id_fase" id="id_fase" required>
      <option value="">Seleccione una Fase</option>
      <!-- Las opciones se llenarán aquí con JavaScript -->
  </select>

  <select name="id_cultivo" id="id_cultivo" required>
      <option value="">Seleccione un Cultivo</option>
      <!-- Las opciones se llenarán aquí con JavaScript -->
  </select>

  <select name="registrada" required>
      <option value="">Seleccione si esta registrada</option>
      <option value="0">No Registrada</option>
      <option value="1">Registrada</option>
  </select>
    <button type="submit">Subir Imagen</button>
  </form>
  <p id="message"></p>

  <h2>Obtener Imagen y Datos</h2>
  <form id="getImageForm">
    <input type="number" id="idParcelacion" placeholder="Ingrese ID de Parcelación" required>
    <button type="submit">Obtener Imagen y Datos</button>
    <button type="button" id="getMatrixButton">Obtener Matriz de Píxeles</button>
  </form>
  <div id="imageContainer"></div>
  <div id="dataContainer"></div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const response = await fetch('/opciones');
            const data = await response.json();

            // Llenar el dropdown de sectores
            const sectorSelect = document.getElementById('id_sector');
            data.sectores.forEach(sector => {
                const option = document.createElement('option');
                option.value = sector.id_sector;
                option.textContent = sector.Sector;
                sectorSelect.appendChild(option);
            });

            // Llenar el dropdown de fases
            const faseSelect = document.getElementById('id_fase');
            data.fases.forEach(fase => {
                const option = document.createElement('option');
                option.value = fase.id_fase;
                option.textContent = fase.nombre;
                faseSelect.appendChild(option);
            });

            // Llenar el dropdown de cultivos
            const cultivoSelect = document.getElementById('id_cultivo');
            data.cultivos.forEach(cultivo => {
                const option = document.createElement('option');
                option.value = cultivo.id_cultivo;
                option.textContent = cultivo.nombre;
                cultivoSelect.appendChild(option);
            });

        } catch (error) {
            console.error('Error al cargar las opciones:', error);
        }
    });

    // Manejar el envío del formulario de carga de imágenes
    document.getElementById('uploadForm').addEventListener('submit', function(event) {
      event.preventDefault();

      const formData = new FormData(this);
      fetch('/upload', {
        method: 'POST',
        body: formData
      })
      .then(response => response.text())
      .then(text => {
        document.getElementById('message').textContent = text;
      })
      .catch(error => {
        document.getElementById('message').textContent = 'Error al subir la imagen.';
        console.error('Error:', error);
      });
    });

    // Manejar el formulario para obtener datos e imagen
    document.getElementById('getImageForm').addEventListener('submit', function(event) {
      event.preventDefault();

      const id = document.getElementById('idParcelacion').value;

      // Obtener los datos
      fetch(`/get-data?id=${id}`)
        .then(response => response.json())
        .then(data => {
          const dataContainer = document.getElementById('dataContainer');
          dataContainer.innerHTML = `
            <p>Latitud: ${data.latitud}</p>
            <p>Longitud: ${data.longitud}</p>
            <p>ID Sector: ${data.id_sector}</p>
            <p>ID Fase: ${data.id_fase}</p>
            <p>ID Cultivo: ${data.id_cultivo}</p>
            <p>Registrada: ${data.registrada}</p>
          `;
        })
        .catch(error => {
          document.getElementById('dataContainer').textContent = 'Error al obtener los datos.';
          console.error('Error:', error);
        });

      // Obtener la imagen
      fetch(`/get-image?id=${id}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('No se pudo obtener la imagen.');
          }
          return response.blob(); // Obtener la imagen como un blob
        })
        .then(blob => {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(blob); // Crear una URL para el blob
          const imageContainer = document.getElementById('imageContainer');
          imageContainer.innerHTML = ''; // Limpiar cualquier imagen previa
          imageContainer.appendChild(img);
        })
        .catch(error => {
          document.getElementById('imageContainer').textContent = 'Error al obtener la imagen.';
          console.error('Error:', error);
        });
    });

    // Manejar el botón para obtener la matriz de píxeles
    document.getElementById('getMatrixButton').addEventListener('click', function() {
      const id = document.getElementById('idParcelacion').value;
      fetch(`/get-pixel-matrix?id=${id}`)
        .then(response => response.text())
        .then(text => {
          // Crear un enlace para descargar el archivo
          const blob = new Blob([text], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'pixel_matrix.txt';
          a.click();
          URL.revokeObjectURL(url);
        })
        .catch(error => {
          document.getElementById('imageContainer').textContent = 'Error al obtener la matriz de píxeles.';
          console.error('Error:', error);
        });
    });
  </script>
</body>
</html>
